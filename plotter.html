<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Plotter</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
  </head>
  <body>
    <div class="chart">

    </div>
    <div class="clear_button">
    </div>
  </body>
  <script>
    var dataset = [];

    var dataMaxY = 50,
        dataMaxX = 50;

    var width = 500,
        height = 350,
        xPadding = 30,
        yPadding = 30,
        xLow = xPadding,
        xHigh = (width - xPadding),
        yLow = (height - yPadding),
        yHigh = yPadding;

    var pointRad = 8,
      regrLine;

    // create the svg
    var svg = d3.selectAll(".chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
    // add border
    svg.append("rect")
       			.attr("x", 0)
       			.attr("y", 0)
       			.attr("height", height)
       			.attr("width", width)
       			.style("stroke", "#AAA")
       			.style("fill", "none")
       			.style("stroke-width", 1);

    var xScale = d3.scaleLinear()
                   .domain([0, dataMaxX])
                   .range([xLow, xHigh]);

    var yScale = d3.scaleLinear()
                   .domain([0, dataMaxY])
                   .range([yLow, yHigh]);   // reversed

    // output coordinates of clicks
    svg.on('click', function() {
      var x = +xScale.invert(d3.event.clientX).toFixed(2),
        y = +yScale.invert(d3.event.clientY).toFixed(2);

      // do nothing if the points are in the padding
      if (x < 0 || y < 0) {
        return;
      }

      // add a new data point
      svg.append("circle")
         .attr("cx", xScale(x))
         .attr("cy", yScale(y))
         .attr("r", pointRad)
         .attr("fill", "#596386")
         .attr("stroke", "white");

      // add the new datapoint to the dataset
      dataset.push([x, y])

      // create the regression line (2 points)
      if (dataset.length == 2) {
        regrLine = svg.append("line")
                      .attr("x1", function() {
                        return xScale(0);
                      })
                      .attr("y1", function() {
                        return yScale((getRegressionParams(dataset)[0]));
                      })
                      .attr("x2", function() {
                        return xScale(dataMaxX);
                      })
                      .attr("y2", function() {
                        var params = getRegressionParams(dataset);
                        return yScale((params[0] + params[1] * dataMaxX));
                      })
                      .attr("stroke-width", 5)
                      .attr("stroke", "#993333")
                      .attr("stroke-linecap", "round");
      }
      // update regression line (more than 2 points)
      if (dataset.length > 2) {
        regrLine.transition()
                .attr("x1", function() {
                  return xScale(0);
                })
                .attr("y1", function() {
                  return yScale((getRegressionParams(dataset)[0]));
                })
                .attr("x2", function() {
                  return xScale(dataMaxX);
                })
                .attr("y2", function() {
                  var params = getRegressionParams(dataset);
                  return yScale((params[0] + params[1] * dataMaxX));
                })
                .attr("stroke-width", 5)
                .attr("stroke", "#993333")
                .attr("stroke-linecap", "round");
      }
    });

    // plot the data points
    svg.selectAll("circle")
       .data(dataset)
       .enter()
       .append("circle")
       .attr("cx", function(d) {
         return xScale(d[0]);
       })
       .attr("cy", function(d) {
         return yScale(d[1]);
       })
       .attr("r", 9)
       .attr("fill", "#596386")
       .attr("stroke", "white");

    // add clear button
    d3.select(".clear_button")
      .append("input")
      .attr("type", "button")
      .attr("value", "clear")
      .attr("align", "center")
      .on("click", function(e) {
        d3.event.preventDefault();
        d3.selectAll("circle")
          .remove();
        regrLine.remove();
        dataset = [];
      });

    function getRegressionParams(data) {
      // calculate average x and y
      var sumX = 0,
          sumY = 0
          sxx = 0,
          sxy = 0,
          n = data.length;
      for (var i = 0; i < data.length; i++) {
        sumX += data[i][0];
        sumY += data[i][1];
      }
      var xBar = sumX / n;
      var yBar = sumY / n;

      // get terms for beta0 and beta1
      for (var i = 0; i < data.length; i++) {
        sxx += Math.pow((data[i][0] - xBar), 2)
        sxy += (data[i][0] - xBar) * (data[i][1] - yBar);
      }

      beta1 = sxy / sxx;
      beta0 = yBar - (beta1 * xBar);

      return [beta0, beta1];
    }

    console.log(getRegressionParams(dataset));
  </script>
</html>
